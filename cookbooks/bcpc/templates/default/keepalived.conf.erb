################################################
#
#              Generated by Chef
#
################################################

global_defs {
  router_id <%=node['hostname']%>
}

vrrp_script chk_haproxy {
  script "killall -0 haproxy"
  interval 1
}

vrrp_script chk_ceph {
  script "/usr/local/bin/if_not_quorum false"
  interval 5
  fall 3
  rise 1
}

vrrp_sync_group VG1_<%=node['bcpc']['region_name']%> {
  group {
    VI1_<%=node['bcpc']['region_name']%>
    VI2_<%=node['bcpc']['region_name']%>
  }
}

vrrp_instance VI1_<%=node['bcpc']['region_name']%> {
  virtual_router_id <%=get_config('keepalived-router-id')%>

  # for electing MASTER, highest priority wins.
  priority  <%= 255-node['bcpc']['node_number'].to_i %>
  state     BACKUP
  nopreempt

  interface <%= node['bcpc']['management']['interface'] %>

  virtual_ipaddress {
    <%="#{node['bcpc']['management']['vip']}/#{(node['bcpc']['management']['cidr'].match /\d+\.\d+\.\d+\.\d+\/(\d+)/)[1].to_i}"%>
  }
  track_script {
    chk_haproxy
    chk_ceph
  }
  authentication {
    auth_type PASS
    auth_pass <%=get_config('keepalived-password')%>
  }
  notify_backup "/usr/local/bin/vip_lost"
  notify_fault "/usr/local/bin/vip_lost"
  notify_master "/usr/local/bin/vip_won"
}

vrrp_instance VI2_<%=node['bcpc']['region_name']%> {
  virtual_router_id <%= get_config('keepalived-router-id').to_i+1 %>

  # for electing MASTER, highest priority wins.
  priority  <%= 255-node['bcpc']['node_number'].to_i %>
  state     BACKUP
  nopreempt

  interface vhost0

  virtual_ipaddress {
    <%="#{node['bcpc']['floating']['vip']}/#{(node['bcpc']['floating']['cidr'].match /\d+\.\d+\.\d+\.\d+\/(\d+)/)[1].to_i}"%>
  }
  authentication {
    auth_type PASS
    auth_pass <%=get_config('keepalived-password')%>
  }
}
